#!/bin/bash
set -e

function init_user {

psql -v ON_ERROR_STOP=1 --username $POSTGRES_USER <<-EOSQL
  CREATE USER $DB_USERNAME WITH ENCRYPTED PASSWORD '$DB_PASSWORD';
  CREATE DATABASE $DB_DATABASE;
  GRANT ALL PRIVILEGES ON DATABASE $DB_DATABASE TO $DB_USERNAME;
EOSQL

}


cat >&2 <<-EOSQL
  CREATE USER $DB_USERNAME WITH ENCRYPTED PASSWORD '$DB_PASSWORD';
  CREATE DATABASE $DB_DATABASE;
  GRANT ALL PRIVILEGES ON DATABASE $DB_DATABASE TO $DB_USERNAME;
EOSQL


[[ ${DB_USERNAME:?Need DB_USERNAME} ]] \
  && [[ ${DB_PASSWORD:? Need DB_PASSWORD} ]] \
  && [[ ${DB_DATABASE:? Need DB_DATABASE} ]] \
  && init_user
